{% extends 'core/base.html' %}
{% load static %}
{% block content %}
<h1>Dashboard</h1>
<div class="container">
    <!-- Search Bar -->
    <div class="mb-4">
        <input type="text" id="search-bar" class="form-control" placeholder="Search by Item, Shop Name, or Bill Date..." autocomplete="off">
        <div id="suggestions-list" class="list-group mt-2" style="position: absolute; z-index: 1000; width: 100%; display: none;"></div>
    </div>

    <!-- Notifications -->
    {% if notifications %}
        <h3>Notifications</h3>
        <ul class="list-group">
            {% for notification in notifications %}
                <li class="list-group-item">
                    Warranty for {{ notification.warranty_card.bill.items|truncatechars:50 }} expires on {{ notification.warranty_card.warranty_end_date|date:'Y-m-d' }}.
                </li>
            {% empty %}
                <li class="list-group-item">No upcoming warranty expirations.</li>
            {% endfor %}
        </ul>
    {% endif %}

    <!-- Bills List -->
    <h3>Your Bills</h3>
    {% if bills %}
        <div class="list-group" id="bills-list">
            {% for bill in bills %}
                <div class="list-group-item" id="bill-{{ bill.id }}">
                    <h4>{{ bill.shop_name }} - {{ bill.bill_date|date:'Y-m-d' }}</h4>
                    <p>Total Amount: {{ bill.total_amount }}</p>
                    <p>Contact: {{ bill.contact_number|default:'N/A' }}</p> <!-- Added contact number -->
                    <p>Items: {{ bill.items|truncatechars:100 }}</p>
                    <div class="row">
                        <!-- Bill Image -->
                        <div class="col-md-6 mb-3 position-relative">
                            <img src="{{ bill.bill_image.url }}" alt="Bill Image" class="img-fluid" style="max-width: 200px; max-height: 200px; object-fit: cover;">
                            <a href="{{ bill.bill_image.url }}" download class="btn btn-sm btn-primary position-absolute" style="top: 5px; right: 5px;">Download</a>
                        </div>
                        <!-- Warranty Image (if exists) -->
                        {% if bill.warrantycard and bill.warrantycard.warranty_image %}
                            <div class="col-md-6 mb-3 position-relative">
                                <img src="{{ bill.warrantycard.warranty_image.url }}" alt="Warranty Image" class="img-fluid" style="max-width: 200px; max-height: 200px; object-fit: cover;">
                                <a href="{{ bill.warrantycard.warranty_image.url }}" download class="btn btn-sm btn-primary position-absolute" style="top: 5px; right: 5px;">Download</a>
                            </div>
                        {% endif %}
                    </div>
                    <a href="{% url 'edit_bill' bill.id %}" class="btn btn-info">Edit</a>
                    <a href="javascript:void(0);" class="btn btn-danger delete-btn" data-bill-id="{{ bill.id }}" onclick="return confirm('Are you sure you want to delete this bill?');">Delete</a>
                    {% if bill.warrantycard %}
                        <a href="{% url 'share_warranty' bill.warrantycard.id %}" class="btn btn-success">Share</a>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>No bills uploaded yet.</p>
    {% endif %}
    <!-- Messages Display -->
    <div id="message-container" class="mt-3"></div>
    <!-- Hidden CSRF Token -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchBar = document.getElementById('search-bar');
        const suggestionsList = document.getElementById('suggestions-list');
        const messageContainer = document.getElementById('message-container');
        const billsList = document.getElementById('bills-list');

        // Search Functionality
        searchBar.addEventListener('input', () => {
            const query = searchBar.value.trim();
            if (query.length < 1) {
                suggestionsList.style.display = 'none';
                return;
            }

            fetch(`{% url 'ajax_search' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    suggestionsList.innerHTML = '';
                    suggestionsList.style.display = data.bills.length > 0 ? 'block' : 'none';
                    data.bills.forEach(bill => {
                        const item = document.createElement('a');
                        item.className = 'list-group-item list-group-item-action';
                        item.href = `javascript:void(0);`;
                        item.textContent = `${bill.shop_name} - ${bill.bill_date} - ${bill.items.substring(0, 50)}...`;
                        item.dataset.billId = bill.id;
                        item.addEventListener('click', () => {
                            searchBar.value = `${bill.shop_name} - ${bill.bill_date}`;
                            suggestionsList.style.display = 'none';
                            scrollToBill(bill.id);
                        });
                        suggestionsList.appendChild(item);
                    });
                })
                .catch(error => console.error('Search error:', error));
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchBar.contains(e.target) && !suggestionsList.contains(e.target)) {
                suggestionsList.style.display = 'none';
            }
        });

        // Scroll to Bill Function
        function scrollToBill(billId) {
            const billElement = document.getElementById(`bill-${billId}`);
            if (billElement) {
                billElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                billElement.classList.add('highlight');
                setTimeout(() => billElement.classList.remove('highlight'), 2000);
            }
        }

        // Delete Functionality
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                if (!confirm('Are you sure you want to delete this bill?')) return;

                const billId = button.getAttribute('data-bill-id');
                fetch(`{% url 'delete_bill' 0 %}`.replace('0', billId), {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        const billElement = document.getElementById(`bill-${billId}`);
                        if (billElement) {
                            billElement.remove(); // Remove from DOM
                            console.log(`Removed bill ${billId} from DOM`);
                        } else {
                            console.warn(`Bill element ${billId} not found in DOM`);
                        }
                        // Display success message
                        if (messageContainer) {
                            messageContainer.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                            setTimeout(() => messageContainer.innerHTML = '', 3000); // Hide after 3 seconds
                        }
                        // Update bills count or hide list if empty
                        const billItems = document.querySelectorAll('.list-group-item');
                        if (billItems.length === 0 && billsList) {
                            billsList.innerHTML = '<p>No bills uploaded yet.</p>';
                            console.log('Updated to no bills message');
                        }
                    } else {
                        console.error('Delete failed:', data.message);
                        messageContainer.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                        setTimeout(() => messageContainer.innerHTML = '', 3000);
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                    messageContainer.innerHTML = `<div class="alert alert-danger">Failed to delete bill: ${error.message}</div>`;
                    setTimeout(() => messageContainer.innerHTML = '', 3000);
                });
            });
        });
    });
</script>

<style>
    .highlight {
        background-color: #ffff99;
        transition: background-color 0.5s;
    }
</style>
{% endblock %}